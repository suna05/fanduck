"use strict";var ngModule=angular.module("app.services",[],function($provide){$provide.decorator("$window",function($delegate){Object.defineProperty($delegate,"history",{get:function(){return null}});return $delegate})});ngModule.factory("SendSrvc",function($rootScope,$http,$q,$timeout,ConfSrvc){return{view:"",status:{},timerid:0,timeout:0,interval:1000,waiting:0,weblink:"",searching:false,init:function(){this.timerid=0;this.timeout=0},newKey:function(data){var deferred=$q.defer();$http({url:ConfSrvc.host+"/web/key",method:"POST",data:data,cache:false}).success(function(res,status,headers,config){deferred.resolve(res)}).error(function(res,status,headers,config){deferred.reject(status)});return deferred.promise},sendKey:function(key,device,comment){$http({url:ConfSrvc.host+"/web/key/push/"+key,method:"POST",data:{device_id:device.device_id,comment:comment}}).error(function(res,status,headers,config){console.log(res)})},updateStatus:function(data){this.status=data;if(data.mode=="cancel"){this.stop()}this.apply()},getStatus:function(url,retry){retry=retry?retry:0;var that=this;var data={mode:"status"};$http({url:url,method:"GET",params:data,cache:false}).success(function(res,status,headers,config){$rootScope.$broadcast("getStatus",res)}).error(function(res,status,headers,config){if(++retry>20){that.stop()}});this.timerid=$timeout(function(){that.getStatus(url,retry)},this.interval)},start:function(url){this.init();var that=this;this.timerid=$timeout(function(){that.getStatus(url)},1000)},stop:function(){$timeout.cancel(this.timerid)},cancel:function(url){var deferred=$q.defer();var that=this;var params={mode:"cancel"};$http({url:url,method:"GET",params:params,cache:false}).success(function(res,status,headers,config){that.stop();res.loaded=res.transfer;res.total=res.length;that.updateStatus(res);deferred.resolve(res)}).error(function(res,status,headers,config){console.error(res);deferred.reject(status)});return deferred.promise},search:function(recentDevices,deferred){if(!this.searching){return}var that=this;var deferred=deferred?deferred:$q.defer();var nearbyDevices=$(ConfSrvc.favorite_devices).not(recentDevices).get();ConfSrvc.updateLocation(function(coords){var prefer_ids="";for(var i in nearbyDevices){prefer_ids+=nearbyDevices[i].device_id+","}var params={prefer_ids:prefer_ids,latitude:coords.latitude,longitude:coords.longitude};$http({url:ConfSrvc.host+"/web/device/nearby",method:"GET",params:params,cache:false}).success(function(res,status,headers,config){if(res.device&&res.device.length>0){res.nearbyDevices=[];res.new_recentDevice=[];for(var i in res.device){var device=res.device[i];if(recentDevices.filter(function(e){return e.device_id==device.device_id}).length==0){res.nearbyDevices.push(device)}else{res.new_recentDevice.push(device)}}if(res.nearbyDevices.length>0||res.new_recentDevice.length>0){that.searching=false;deferred.resolve(res);return}}$timeout(function(){that.search(recentDevices,deferred)},3000)}).error(function(res,status,headers,config){$timeout(function(){that.search(recentDevices,deferred)},3000)})});return deferred.promise},stopSearch:function(){var self=this;$.ajax({url:ConfSrvc.host+"/web/device/nearby/wait",type:"DELETE",cache:false}).done(function(res){self.searching=false}).fail(function(xhr,textStatus,err){})},apply:function(){if(!$rootScope.$$phase){$rootScope.$apply()}},deleteKey:function(key){$http({method:"DELETE",url:ConfSrvc.host+"/web/key/"+key}).success(function(data,status,headers,config){}).error(function(data,status,headers,config){})},switchView:function(view){if(view!="tran"){this.status={}}if(!view){view=this.view}else{this.view=view}},notify:function(icon,title,content){var duration=5000;var options={type:"basic",title:title,message:content,iconUrl:icon};if(window.webkitNotifications){var notification=webkitNotifications.createNotification(icon,title,content);notification.onclick=function(event){event.currentTarget.cancel()};if(duration>0){notification.ondisplay=function(event){setTimeout(function(){event.currentTarget.cancel()},duration)}}notification.show()}else{chrome.notifications.create("",options,function(id){})}},updateFavoriteDevice:function(retry){var that=this;retry=retry?retry:0;$http({url:this.weblink,params:{mode:"status"},method:"GET",cache:false}).success(function(res,status,headers,config){if(!res.peer_device_id){if(retry<3){$timeout(function(){that.updateFavoriteDevice(retry+1)},3000)}}else{var devices=ConfSrvc.favorite_devices;var now=new Date();for(var i in devices){var device=devices[i];if(now-new Date(device.updated)>1000*60*60*24*90){delete devices[i]}}$http.get(ConfSrvc.host+"/web/device/"+res.peer_device_id).success(function(res,status,headers,config){if(res.device.length>0){var device=res.device[0];for(var i in devices){if(device.device_id==devices[i].device_id){device=devices[i];break}}device.updated=new Date();if(device.count){++device.count}else{device.count=1;devices.push(device)}ConfSrvc.apply()}})}}).error(function(res,status,headers,config){if(retry<3){$timeout(function(){SendSrvc.updateFavoriteDevice(retry+1)},3000)}})}}});ngModule.factory("RecvSrvc",function($rootScope,$http,$q,$timeout,ConfSrvc){return{view:"",status:{},timerid:0,timeout:0,interval:1000,waiting:0,weblink:"",published:false,searching:false,receiving:false,hasPush:false,init:function(){this.timerid=0;this.timeout=0},newKey:function(data){var deferred=$q.defer();$http({url:ConfSrvc.host+"/web/key",method:"POST",data:data,cache:false}).success(function(res,status,headers,config){deferred.resolve(res)}).error(function(res,status,headers,config){deferred.reject(res)});return deferred.promise},getKey:function(key){var deferred=$q.defer();$http({url:ConfSrvc.host+"/web/key/"+key,method:"GET",cache:false}).success(function(res,status,headers,config){deferred.resolve(res)}).error(function(res,status,headers,config){deferred.reject(res)});return deferred.promise},updateStatus:function(data){this.status=data;if(data.mode=="cancel"){this.stop()}this.apply()},getStatus:function(url,retry){retry=retry?retry:0;var that=this;var data={mode:"status"};$http({url:url,method:"GET",params:data,cache:false}).success(function(res,status,headers,config){$rootScope.$broadcast("getRecvStatus",res)}).error(function(res,status,headers,config){if(++retry>20){that.stop()}});this.timerid=$timeout(function(){that.getStatus(url,retry)},this.interval)},start:function(url){this.init();var that=this;this.timerid=$timeout(function(){that.getStatus(url)},1000)},stop:function(){$timeout.cancel(this.timerid)},cancel:function(url){var that=this;var params={mode:"cancel",device_key:ConfSrvc.device_key};$http({url:url,method:"GET",params:params,cache:false}).success(function(res,status,headers,config){that.stop();res.loaded=res.transfer;res.total=res.length;that.updateStatus(res)}).error(function(res,status,headers,config){console.error(res)})},stopWaiting:function(){this.waiting=0;this.searching=false;var that=this;$http({url:ConfSrvc.host+"/web/device/nearby/wait",method:"DELETE",cache:false}).success(function(res,status,headers,config){that.published=false;that.receiving=true})},startWaiting:function(){var that=this;var deferred=$q.defer();if(!this.published){ConfSrvc.updateLocation(function(coords){var body={latitude:coords.latitude,longitude:coords.longitude};$timeout(function(){$http({url:ConfSrvc.host+"/web/device/nearby/wait",method:"POST",body:body,cache:false}).success(function(res,status,headers,config){that.waiting=1;that.published=true;that.receiving=false;that.startWaiting()}).error(function(res,status,headers,config){that.startWaiting()})},3000)});return}else{if(that.waiting++>99){that.stopWaiting();return}}},waitKey:function(res){var that=this;var key=res.key;if(!that.hasPush&&!that.receiving&&key){that.stopWaiting();$http({url:ConfSrvc.host+"/web/key/device/"+key,method:"GET"}).success(function(res,status,headers,config){res.key=key;that.hasPush=true;$rootScope.$broadcast("waitKey",res)}).error(function(res,status,headers,config){that.startWaiting()})}else{if(that.waiting){that.startWaiting()}}},apply:function(){if(!$rootScope.$$phase){$rootScope.$apply()}},switchView:function(view){if(view!="tran"){this.status={}}if(!view){view=this.view}else{this.view=view}if(view=="tran"){if(this.waiting){this.stopWaiting()}}else{if(!this.waiting){this.startWaiting()}}},notify:function(icon,title,content){var duration=5000;var options={type:"basic",title:title,message:content,iconUrl:icon};if(window.webkitNotifications){var notification=webkitNotifications.createNotification(icon,title,content);notification.onclick=function(event){event.currentTarget.cancel()};if(duration>0){notification.ondisplay=function(event){setTimeout(function(){event.currentTarget.cancel()},duration)}}notification.show()}else{chrome.notifications.create("",options,function(id){})}},updateFavoriteDevice:function(retry){var that=this;retry=retry?retry:0;$http({url:this.weblink,params:{mode:"status"},method:"GET",cache:false}).success(function(res,status,headers,config){if(!res.peer_device_id){if(retry<3){$timeout(function(){that.updateFavoriteDevice(retry+1)},3000)}}else{var devices=ConfSrvc.favorite_devices;var now=new Date();for(var i in devices){var device=devices[i];if(now-new Date(device.updated)>1000*60*60*24*90){delete devices[i]}}$http.get(ConfSrvc.host+"/web/device/"+res.peer_device_id).success(function(res,status,headers,config){if(res.device.length>0){var device=res.device[0];for(var i in devices){if(device.device_id==devices[i].device_id){device=devices[i];break}}device.updated=new Date();if(device.count){++device.count}else{device.count=1;devices.push(device)}ConfSrvc.apply()}})}}).error(function(res,status,headers,config){if(retry<3){$timeout(function(){RecvSrvc.updateFavoriteDevice(retry+1)},3000)}})}}});ngModule.factory("ListSrvc",function($rootScope,$http,$q,$timeout,ConfSrvc){return{view:"",timerid:0,timeout:0,init:function(){this.timerid=0;this.timeout=0},stop:function(){$timeout.cancel(this.timerid)},cancel:function(url){var that=this;var params={mode:"cancel",device_key:ConfSrvc.device_key};$http({url:url,method:"GET",params:params,cache:false}).success(function(res,status,headers,config){that.stop();res.loaded=res.transfer;res.total=res.length;that.updateStatus(res)}).error(function(res,status,headers,config){console.error(res)})},apply:function(){if(!$rootScope.$$phase){$rootScope.$apply()}},switchView:function(view){if(!view){view=this.view}else{this.view=view}}}});ngModule.factory("ConfSrvc",function($rootScope,$http){return{host:"https://send-anywhere.com",apply:function(){var conf={device_key:this.device_key,profile_name:this.profile_name,favorite_devices:this.favorite_devices};chrome.storage.sync.set({configuration:conf},function(){if(!$rootScope.$$phase){$rootScope.$apply()}})},getTopFavoriteDevices:function(n){var that=this;var devices=this.favorite_devices.filter(function(e){var index=that.favorite_devices.indexOf(e);if(that.favorite_devices[index]==null){that.favorite_devices.splice(index,1);return false}return e.has_pushid});devices.sort(function(a,b){return b.count-a.count});var device_list=n>0?devices.slice(0,n):devices;return device_list},updateDevice:function(){var that=this;chrome.storage.sync.get("deviceInfo",function(result){var data={cache:false,profile_name:that.profile_name,os_type:"web",manufacturer:"google",model_number:"ChromeApp",app_name:"Send Anywhere Chrome App",app_version:chrome.runtime.getManifest().version,device_language:chrome.i18n.getMessage("@@ui_locale")};if(result.deviceInfo.device_uid){data.device_uid=result.deviceInfo.device_uid}if(result.deviceInfo.push_id){data.push_id=result.deviceInfo.push_id}if(that.device_key){data.device_key=that.device_key}$http({method:"POST",url:that.host+"/web/device",data:data}).success(function(res){if(res&&res.device_key){that.device_key=res.device_key;that.apply()}})})},update:function(callback){var that=this;chrome.storage.sync.get("configuration",function(result){var conf=result.configuration;if(!conf){conf={}}that.profile_name=conf.profile_name?conf.profile_name:"My Chrome App";that.favorite_devices=conf.favorite_devices?conf.favorite_devices:[];if(conf.device_key){that.device_key=conf.device_key}that.updateDevice();if(typeof(callback)=="function"){callback()}})},isFavorite:function(device){for(var i in this.favorite_devices){var favorite=this.favorite_devices[i];if(favorite.device_id==device.device_id){return true}}return false},updateLocation:function(callback){if(this.coords){callback(this.coords)}else{var that=this;navigator.geolocation.getCurrentPosition(function(position){that.coords=position.coords;callback(that.coords)},function(error){console.log(error);callback(that.coords)})}}}});