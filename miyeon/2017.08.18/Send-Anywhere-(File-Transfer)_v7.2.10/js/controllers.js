"use strict";angular.module("app.controllers",["ngSanitize"]).controller("AppCtrl",["$scope","$rootScope","$location","$route","ConfSrvc","RecvSrvc",function($scope,$rootScope,$location,$route,ConfSrvc,RecvSrvc){$scope.init=function(){var messageHandler=function(e){RecvSrvc.waitKey(e.data)};window.addEventListener("message",messageHandler)};$scope.init();$scope.getMessage=function(msg,args){return chrome.i18n.getMessage(msg,args)};$scope.getProgress=function(loaded,total){if(!total){return 0}return parseInt(loaded/Math.max(1,total)*100,10)};$scope.getFileSize=function(n){if(!n){return 0+" B"}else{if(n<=1024){return n+" B"}else{if(n<=1024*1024){return Math.round(n/1024*100)/100+" KB"}else{if(n<=1024*1024*1024){return Math.round(n/1024/1024*100)/100+" MB"}else{return Math.round(n/1024/1024/1024*100)/100+" GB"}}}}};$scope.computedExp=function(d){var now=new Date().getTime();var date=$scope.convertUTCtoLocal(new Date(d));var month=$scope.getMessage("month_"+(date.getMonth()+1));var day=date.getDate();var hours=date.getHours();var apm=(hours<12)?"AM":"PM";var minutes=$scope.addZero(date.getMinutes());if(hours>12){hours-=12}var exp_format=$scope.getMessage("exp_format",[month,day]);return exp_format+" "+hours+":"+minutes+" "+apm};$scope.convertUTCtoLocal=function(d){var date=new Date(d),offset=d.getTimezoneOffset()/60,hours=d.getUTCHours();date.setHours(hours-offset);return date};$scope.addZero=function(n){n=n<10?"0"+n:n;return n};$scope.moveTab=function(location){$("#tabs").tabs("option","active",location)};$scope.listReload=function(){$rootScope.$broadcast("listInit",true)};$scope.copyToClipboard=function(text){document.execCommand("copy");var copyFrom=$("<textarea/>");copyFrom.text(text);$("body").append(copyFrom);copyFrom.select();document.execCommand("copy");copyFrom.remove();bootbox.alert($scope.getMessage("noti_copy"))};$scope.showPopup=function(element){$(element).removeClass("hidden")};$scope.hiddenPopup=function(element){if(element==".device-popup"){$(".device-scroll").scrollTop(0)}$(element).addClass("hidden")}}]).controller("SendCtrl",["$scope","$rootScope","$timeout","$location","$route","fileUpload","SendSrvc","ConfSrvc",function($scope,$rootScope,$timeout,$location,$route,fileUpload,SendSrvc,ConfSrvc){$scope.init=function(){this.upload=false;this.key="000000";this.qr_code="./css/images/loading.gif";this.totalFileNum=0;this.totalFileSize=0;this.path=$location.path();this.expiration_time=0;this.isClicked=false;this.sending=false;this.nearbyDevices=[];this.recentDevices=[];this.mode="send";this.queue=[];this.wait_per=100;this.send_url="";this.num=0;this.filename="";$("#wait_time").runner("reset");$(".type_01 .btn").removeClass("active-btn");$(".device-popup").addClass("hidden");$(".qr-popup").addClass("hidden");$(".file-table").scrollTop(0);$("#file").val("");SendSrvc.switchView("send");var options={html:true,placement:"bottom",delay:{show:100,hide:100},trigger:"hover",content:'<div class="help-popover"><p>'+$scope.getMessage("help_desc01")+"</p><p>"+$scope.getMessage("help_desc02")+"</p><ul><li>"+$scope.getMessage("help_list01")+"</li><li>"+$scope.getMessage("help_list03")+"</li></ul><div>"};$(".help-btn").popover(options);SendSrvc.stop()};$scope.init();$scope.view=function(){return SendSrvc.view};$scope.goList=function(){$rootScope.$broadcast("listInit",true);$scope.moveTab(2);$scope.init()};$scope.send_status=function(){return SendSrvc.status};$scope.fileInputClick=function(){var elem=document.getElementById("file");if(elem&&document.createEvent){var evt=document.createEvent("MouseEvents");evt.initEvent("click",true,false);setTimeout(function(){elem.dispatchEvent(evt)},150)}};$scope.getSendKey=function(upload){if($scope.isClicked){return}var files=$scope.queue;if(files.length>0){var total_size=0;for(var i=0;i<files.length;i++){total_size+=files[i].size}if(upload&&total_size>2*1024*1024*1024){bootbox.dialog({message:$scope.getMessage("size_exceed_desc"),buttons:{main:{label:$scope.getMessage("extension_install"),callback:function(){window.open("https://chrome.google.com/webstore/detail/send-anywherefile-transfe/amjmjholfoknokffkiolahocokcaecnc");bootbox.hideAll()}}}});return}$scope.isClicked=true;if(upload){$scope.upload=upload}var data={};if(total_size){data.file=[];for(var i in files){var file=files[i];data.file.push({name:file.name,size:file.size})}}}if($scope.upload){data.async=1;data.secure=0;data.mode="upload"}SendSrvc.newKey(data).then(function(res){if(!$scope.upload){SendSrvc.switchView("wait");$("#wait_time").runner("start")}$scope.getKeyTag=function(){var key_tag=res.key.split("").map(function(digit){var _class=isNaN(digit)?"char-digit":"";return"<span class='"+_class+"'>"+digit+"</span>"}).join("");return key_tag};$scope.key=res.key;$scope.short_url=res.link;$scope.expiration_date=res.expires_time*1000;$scope.exp_date=$scope.computedExp(res.expires_time*1000);var xhr=new XMLHttpRequest();xhr.open("GET","https://chart.googleapis.com/chart?chs=120x120&chld=l|0&cht=qr&chl="+res.link,true);xhr.responseType="blob";xhr.onload=function(e){$scope.qr_code=window.URL.createObjectURL(this.response);SendSrvc.apply()};xhr.send();$scope.send_url=res.weblink;$scope.sendFiles()},function(status){if(status==413){bootbox.dialog({message:$scope.getMessage("length_exceed_desc"),buttons:{main:{label:$scope.getMessage("extension_install"),callback:function(){window.open("https://chrome.google.com/webstore/detail/send-anywherefile-transfe/amjmjholfoknokffkiolahocokcaecnc");bootbox.hideAll()}}}});$scope.init()}})};$scope.search=function(){$timeout(function(){$(".device-popup").removeClass("hidden")},300);if(SendSrvc.searching){return}SendSrvc.searching=true;$scope.nearbyDevices=[];SendSrvc.search(ConfSrvc.getTopFavoriteDevices(4)).then(function(res){$scope.nearbyDevices=res.nearbyDevices;$scope.recentDevices=res.new_recentDevice;$(".btn-group").addClass("open");$timeout(function(){$(".device-popup").removeClass("hidden")},300)})};$scope.stopSearch=function(){if(!SendSrvc.searching){return}SendSrvc.stopSearch()};$scope.sendKey=function(device){var comment=$scope.getMessage("push_comment");SendSrvc.sendKey($scope.key,device,comment);$(".device-popup").addClass("hidden")};$scope.sendFiles=function(){var files=$scope.queue;$("#fileupload").attr("action",$scope.send_url);$scope.submit();$scope.sending=true;if($scope.upload){SendSrvc.switchView("tran")}else{SendSrvc.start($scope.send_url)}SendSrvc.weblink=$scope.send_url};$scope.cancelWait=function(){$("#wait_time").runner("stop");SendSrvc.cancel($scope.send_url).then(function(res){if($scope.xhr){setTimeout(function(){$scope.xhr.abort()},300)}SendSrvc.deleteKey($scope.key);SendSrvc.stop();$scope.init();if(SendSrvc.searching){$scope.stopSearch()}},function(err){SendSrvc.stop();$scope.init()})};$scope.cancelTransfer=function(destroyed){$scope.sending=false;SendSrvc.cancel($scope.send_url).then(function(res){if(!destroyed){$scope.cancel()}},function(err){});$scope.init()};$scope.getUploadingFile=function(loaded){var total=0;for(var i=0;i<$scope.queue.length;++i){var file=$scope.queue[i];total+=file.size;if(total>=loaded){return file}}};$scope.getButtonType=function(){if(!SendSrvc.status.mode){return"cancel"}else{if(SendSrvc.status.mode=="complete"&&$scope.upload){return"list"}else{return"main"}}};$scope.notifyDone=function(){var notiTitle="";if($scope.upload){notiTitle=$scope.getMessage("noti_save_done")}else{notiTitle=$scope.getMessage("noti_send_done")}var notiContent="";for(var i in $scope.queue){var file=$scope.queue[i];notiContent+=file.name+" ("+$scope.getFileSize(file.size)+")\n"}SendSrvc.notify("css/images/desktop_noti.jpg",notiTitle,notiContent);SendSrvc.updateFavoriteDevice()};$("#wait_time").runner({countdown:true,startAt:600000,stopAt:0,interval:1000,milliseconds:false,format:function(val){$scope.wait_per=val/600000*100;return $scope.getMessage("will_expire",[sprintf("%02d:%02d",val/60000,(val/1000)%60)])}}).on("runnerFinish",function(evt,info){$scope.cancelWait()});$scope.$on("getStatus",function(event,data){if(data.mode!="wait"){SendSrvc.stop();if(SendSrvc.status.mode=="complete"){$scope.notifyDone()}SendSrvc.switchView("tran");$("#wait_time").runner("stop")}});$scope.$on("fileuploadadd",function(e,data){if(data.files.length==0){data.files.length=0;return}$scope.$broadcast("fileaddLoad",true);var files=[];var fileSize=0;for(var i=0;i<data.files.length;++i){var file=data.files[i];if(file.size>0){fileSize+=file.size;files.push(file)}}data.files=files;$scope.totalFileNum+=data.files.length;$scope.totalFileSize+=fileSize;$scope.queue.forEach(function(item){delete item.$submit;data.files.push(item)});$(".type_01 .btn").addClass("active-btn");$scope.queue.length=0});$scope.$on("fileaddLoad",function(event,load_status){$scope.loading=load_status});var prevProgress=0;$scope.$on("fileuploadprogressall",function(event,data){var current=$scope.getUploadingFile(data.loaded);if(current){$scope.filename=current.name}var progress=$scope.getProgress(data.loaded,data.total);if(progress==100){if(SendSrvc.view!="wait"&&$scope.upload){$scope.notifyDone()}$scope.sending=false;data.mode="complete";SendSrvc.updateStatus(data);if($scope.upload){var uploadData={key:$scope.key,expiration_date:$scope.expiration_date,files:[]};for(var i in $scope.queue){var item=$scope.queue[i];var file={name:item.name,size:item.size};uploadData.files.push(file)}chrome.storage.local.get("uploads",function(result){var uploads=result.uploads;if(!uploads){uploads=[uploadData]}else{uploads.push(uploadData)}chrome.storage.local.set({uploads:uploads})})}}else{data.mode="";SendSrvc.updateStatus(data)}if(progress>prevProgress){SendSrvc.updateStatus(data)}prevProgress=progress});$scope.$on("fileuploadfail",function(event,data){data.mode="cancel";SendSrvc.updateStatus(data)});$scope.$on("$destroy",function(){if(SendSrvc.view=="wait"){$scope.cancelWait()}else{if($scope.sending){$scope.cancelTransfer(true)}}})}]).controller("RecvCtrl",["$scope","$location","RecvSrvc","ConfSrvc",function($scope,$location,RecvSrvc,ConfSrvc){$scope.init=function(){this.key="";this.push_key="";this.errmsg="";this.isClicked=true;this.receiving=false;this.recv_link="";this.mode="recv";this.recv_num=0;this.filename="";$(".receive-btn").removeClass("active-btn");RecvSrvc.stop();$("#recv_key").bind("keyup",function(event){if(event.keyCode==13&&$scope.key&&$scope.key.length>0){$scope.getRecvKey()}});$("#recv_key").focus();ConfSrvc.update(function(){$scope.profile_name=ConfSrvc.profile_name;RecvSrvc.apply()});RecvSrvc.switchView("recv")};$scope.$on("waitKey",function(evt,data){if(data){var message=$scope.getMessage("wait_notice",[data.profile_name,data.device_name]);if(data.file_size){message+=" ("+$scope.getFileSize(data.file_size)+")"}var options={message:message,callback:function(ok){if(ok){$scope.init();$scope.moveTab(1);$scope.isClicked=false;$scope.push_key=data.key;$scope.getRecvKey()}else{RecvSrvc.startWaiting()}RecvSrvc.hasPush=false}};bootbox.confirm(options)}else{RecvSrvc.startWaiting()}});$scope.view=function(){return RecvSrvc.view};$scope.recv_status=function(){return RecvSrvc.status};$scope.$watch("key",function(){if($scope.key&&$scope.key.length>0){$(".receive-btn").addClass("active-btn");$scope.isClicked=false;if(event.keyCode==13){$scope.getRecvKey()}}else{$(".receive-btn").removeClass("active-btn");$scope.isClicked=true}if(!$scope.key){$scope.errmsg=""}});$scope.getRecvKey=function(event){if($scope.isClicked||!($scope.key||$scope.push_key)){return}$scope.isClicked=true;var recv_key=$scope.key.replace("http://sendanywhe.re/","").replace("sendanywhe.re/","");if(!recv_key){if($scope.push_key){recv_key=$scope.push_key}$scope.push_key=""}RecvSrvc.getKey(recv_key).then(function(res){if(res.key){$scope.recvFile(res)}else{$scope.errmsg="wrong_key";$scope.isClicked=false}},function(){$scope.errmsg="wrong_key";$scope.isClicked=false})};$scope.recvFile=function(res){RecvSrvc.weblink=res.weblink;var now=new Date();$scope.recv_url=res.weblink;$scope.recv_url+="&timezone="+(-now.getTimezoneOffset()/60);$scope.receiving=true;if(res.file_size&&res.file_size<30000000){var total=null;var xhr=new XMLHttpRequest();xhr.open("GET",$scope.recv_url,true);xhr.responseType="blob";xhr.onprogress=function(evt){if(!$scope.filename){$scope.filename=$scope.getFilenameFromHeader(xhr)}var data={loaded:evt.loaded,total:evt.total};if(evt.lengthComputable==false||data.total==0){data.total=res.file_size}total=data.total;$scope.recv_num=$scope.getProgress(data.loaded,data.total);if($scope.recv_num>=100){data.mode="complete"}RecvSrvc.updateStatus(data)};xhr.onload=function(evt){if(!$scope.filename){$scope.filename=$scope.getFilenameFromHeader(xhr)}var status=evt.currentTarget.status;if(status==200){if(!total||$scope.recv_num<100){$scope.response=evt.target.response;RecvSrvc.start($scope.recv_url)}else{$scope.receiving=false;$scope.notifyDone(total);$scope.saveAs(evt.target.response,$scope.filename)}}else{if(status==404){RecvSrvc.updateStatus({mode:"wrong_key"})}else{RecvSrvc.updateStatus({mode:"error"})}}};xhr.onerror=function(evt){$scope.cancelTransfer()};xhr.send();$scope.xhr=xhr}else{var webview=document.getElementById("webview");webview.setAttribute("src",$scope.recv_url);var permissionrequest=function(e){if(e.permission==="download"){e.request.allow()}};webview.addEventListener("permissionrequest",permissionrequest);webview.addEventListener("loadabort",function(e){e.preventDefault()});RecvSrvc.start($scope.recv_url)}RecvSrvc.switchView("tran")};$scope.getButtonType=function(){if(!RecvSrvc.status.mode){$scope.startWait=false;return"cancel"}else{$scope.startWait=true;return"main"}};$scope.$watch("startWait",function(){if($scope.startWait){RecvSrvc.startWaiting()}});$scope.cancelTransfer=function(){if($scope.xhr){$scope.xhr.abort()}$scope.receiving=false;RecvSrvc.cancel($scope.recv_url)};$scope.saveAs=function(blob,filename){chrome.fileSystem.chooseEntry({type:"saveFile",suggestedName:$scope.filename},function(writableFileEntry){if(writableFileEntry){writableFileEntry.createWriter(function(writer){writer.onerror=function(e){console.error(e)};writer.onwriteend=function(){};writer.write(blob)},function(e){console.error(e)})}else{}})};$scope.notifyDone=function(total){if(total){var notiTitle=$scope.getMessage("noti_download_done");var notiContent=$scope.filename+" ("+$scope.getFileSize(total)+")";RecvSrvc.notify("css/images/desktop_noti.jpg",notiTitle,notiContent);RecvSrvc.updateFavoriteDevice()}};$scope.$on("getRecvStatus",function(evt,data){if(!$scope.filename){$scope.filename=data.name}data.loaded=data.transfer;data.total=data.length;$scope.last_recv_num=$scope.recv_num;$scope.recv_num=$scope.getProgress(data.loaded,data.total);if($scope.last_recv_num!=$scope.recv_num&&$scope.recv_num>=100){$scope.receiving=false;RecvSrvc.stop();data.mode="complete";if($scope.response){$scope.saveAs($scope.response,$scope.filename)}$scope.notifyDone(data.total)}RecvSrvc.updateStatus(data)});$scope.$on("$destroy",function(){if($scope.receiving){$scope.cancelTransfer()}});$scope.getFilenameFromHeader=function(xhr){var filename="";var cd=xhr.getResponseHeader("Content-Disposition");if(cd){filename=cd.split('"')[1];if(filename){filename=decodeURIComponent(escape(filename))}}return filename};$scope.updateProfileName=function(){bootbox.prompt({title:$scope.getMessage("conf_profile_name"),className:"profile-input",buttons:{confirm:{label:$scope.getMessage("edit")},cancel:{label:$scope.getMessage("cancel")}},callback:function(ret){if(ret){$scope.profile_name=ret;ConfSrvc.profile_name=ret;ConfSrvc.updateDevice();ConfSrvc.apply();RecvSrvc.stopWaiting();RecvSrvc.startWaiting()}}});$(".profile-input input").attr("maxlength","20")};$scope.init()}]).controller("ListCtrl",["$scope","$rootScope","$http","ListSrvc","ConfSrvc",function($scope,$rootScope,$http,ListSrvc,ConfSrvc){$scope.init=function(){this.filenames=[];chrome.storage.local.get("uploads",function(data){var now=new Date();var newList=[];var oldList=data.uploads;if(oldList){for(var i in oldList){var item=oldList[i];item.expiration_date=new Date(item.expiration_date);if(now<item.expiration_date){newList.push(item)}}$scope.uploads=newList;ListSrvc.apply();ListSrvc.switchView("list");if(oldList.length!=newList.length){chrome.storage.local.set({uploads:newList})}}});ListSrvc.stop()};$scope.init();$rootScope.$on("listInit",function(){$scope.init()});$scope.clickDelete=function(item){var options={message:$scope.getMessage("noti_delete"),buttons:{cancel:{label:$scope.getMessage("cancel"),className:"btn-default"},"delete":{label:$scope.getMessage("delete"),className:"btn-danger",callback:function(){$scope.deleteKey(item)}}}};bootbox.dialog(options)};$scope.cleanupDeletedItem=function(item){chrome.storage.local.get("uploads",function(data){var newList=[];var oldList=data.uploads;for(var i in oldList){if(oldList[i].key!=item.key){newList.push(oldList[i])}}chrome.storage.local.set({uploads:newList});$scope.init()})};$scope.sumFileSize=function(uploads,key){var sumSize=0;for(var item in uploads){if(uploads[item].key==key){for(var i=0;i<uploads[item].files.length;i++){sumSize+=uploads[item].files[i].size}}}return sumSize};$scope.deleteKey=function(item){$http({method:"DELETE",url:ConfSrvc.host+"/web/key/"+item.key}).success(function(data,status,headers,config){$scope.cleanupDeletedItem(item)}).error(function(data,status,headers,config){$scope.cleanupDeletedItem(item)})};$scope.showDetail=function(evt,uploads,key){var BOX_WIDTH=180;var BODY_HEIGHT=320;var NAV_HEIGET=45;var element=evt.currentTarget.getBoundingClientRect();var tp,lp;var style={};var filenames=[];for(var item in uploads){var uploadItem=uploads[item];if(uploadItem.key==key){for(var i=1;i<uploadItem.files.length;i++){if(i>5){var more=$scope.getMessage("filelist_more_desc",[uploadItem.files.length-i]);filenames.push(more);break}filenames.push(uploadItem.files[i].name)}}}if((element.top-NAV_HEIGET)>=BODY_HEIGHT/2){$(".list-box .detail-box").removeClass("down").addClass("up");style.bottom=(BODY_HEIGHT+NAV_HEIGET-element.top+16)+"px"}else{$(".list-box .detail-box").removeClass("up").addClass("down");style.top=(element.bottom)+"px"}style.left=(element.left+(element.width/2)-(BOX_WIDTH/2)-2)+"px";$(".list-box .detail-box").removeAttr("style").css(style);$scope.filenames=filenames};$scope.closeDetail=function(){$scope.filenames=[]}}]);